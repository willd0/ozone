<div class="p-5 mb-4 <%= @api_color %> rounded-3">
      <div class="container-fluid py-5">
        <h1 class="display-5 fw-bold">
          <%= @final_output %>
        </h1>
        <p class="col-md-8 fs-4">
          This is the current ozone air quality readout for the selected location.
        </p>
        <div id='map' style='width: 400px; height: 300px;'></div>
       
        <script>
          mapboxgl.accessToken = access_token;

          navigator.geolocation.getCurrentPosition(successLocation, errorLocation, { enableHighAccuracy: true })

          function successLocation(position) {
            setupMap([position.coords.longitude, position.coords.latitude])
          }

          function errorLocation() {
            setupMap([-2.24, 53.48])
          }

          function setupMap(center) {
            const map = new mapboxgl.Map({
              container: 'map', // container ID
              style: 'mapbox://styles/mapbox/streets-v11', // style URL
              center: center, // starting position [lng, lat]
              zoom: 9 // starting zoom
          })
            
            const nav = new mapboxgl.NavigationControl();
            map.addControl(nav);

            const marker = new mapboxgl.Marker({
              color: "blue",
              draggable: true,
              
            })
            .setLngLat(center)
            .addTo(map);
            var currentmarker = marker;
            var lLat = currentmarker.getLngLat();
            var c = map.getCenter();
            console.log(c);
            fetch('http://api.openweathermap.org/data/2.5/air_pollution?lat=' + c.lat + '&lon=' + c.lng + '&appid=api_key')
              .then(response => response.json())
              .then(data => {
                var final_out = data.list[0].main.aqi;
                checkAQI(final_out, lLat);
              });
            marker.on('dragend', onDragEnd);
            

            function checkAQI(final_output, lngLat) {
              if (final_output == undefined) {
                    color: "silver"
                  } else if (final_output == 1) {
                    currentmarker.remove();
                    const marker2 = new mapboxgl.Marker({
                      color: "green",
                      draggable: true,
                      
                    })
                    .setLngLat(lngLat)
                    .addTo(map);
                    currentmarker = marker2;
                    marker2.on('dragend', onDragEnd);

                  } else if (final_output == 2) {
                    currentmarker.remove();
                    const marker3 = new mapboxgl.Marker({
                      color: "yellow",
                      draggable: true,
                      
                    })
                    .setLngLat(lngLat)
                    .addTo(map);
                    currentmarker = marker3;
                    marker3.on('dragend', onDragEnd);
        
                  } else if (final_output == 3) {
                    currentmarker.remove();
                    const marker4 = new mapboxgl.Marker({
                      color: "orange",
                      draggable: true,
                      
                    })
                    .setLngLat(lngLat)
                    .addTo(map);
                    currentmarker = marker4;
                    marker4.on('dragend', onDragEnd);
                    
                  } else if (final_output == 4) {
                    currentmarker.remove();
                    const marker5 = new mapboxgl.Marker({
                      color: "red",
                      draggable: true,
                      
                    })
                    .setLngLat(lngLat)
                    .addTo(map);
                    currentmarker = marker5;
                    marker5.on('dragend', onDragEnd);
                    
                  } else if (final_output == 5) {
                    currentmarker.remove();
                    const marker6 = new mapboxgl.Marker({
                      color: "purple",
                      draggable: true,
                      
                    })
                    .setLngLat(lngLat)
                    .addTo(map);
                    currentmarker = marker6;
                    marker6.on('dragend', onDragEnd);
                    
                  } else if (final_output >= 6) {
                    currentmarker.remove();
                    const marker7 = new mapboxgl.Marker({
                      color: "maroon",
                      draggable: true,
                      
                    })
                    .setLngLat(lngLat)
                    .addTo(map);
                    currentmarker = marker7;
                    marker7.on('dragend', onDragEnd);
                    
                  }
            }
            
            function onDragEnd() {
              var lngLat = currentmarker.getLngLat();
              const coordinates = [lngLat.lng, lngLat.lat]
              console.log('Longitude: ' + lngLat.lng + ' Latitude: ' + lngLat.lat);
              map.flyTo ({
                center: [
                  lngLat.lng,
                  lngLat.lat
                ],
                essential: false
              });
              fetch('http://api.openweathermap.org/data/2.5/air_pollution?lat=' + lngLat.lat + '&lon=' + lngLat.lng + '&appid=api_key')
                .then(response => response.json())
                .then(data => {
                  console.log(data.list[0].main.aqi);
                  var final_output = data.list[0].main.aqi;
                  checkAQI(final_output, lngLat);

                })

            }
            
          }
        </script>
        <br/>
      </div>
    </div>
    <br/>
